@{
    ViewData["Title"] = "Serwis pogodowy:";
}
<label>Pogoda dla: 
    <p></p>
</label>
<select class="form-select" id="citySelect" style="width:300px;"></select>
<select class="form-select" id="systemChoose" style="width:300px;"></select>
<div id = "iconInfo">
   <p></p>
</div>

 <table id="cityTable" class="table table-hover table-striped table-bordered">
     <thead>
        <tr>
            <th>
                @Html.DisplayName("Wilgotność")
            </th>
             <th>
                @Html.DisplayName("Prędkość wiatru")
            </th>
             <th>
                @Html.DisplayName("Kierunek wiatru")
            </th>
             <th>
                @Html.DisplayName("Opis tekstowy pogody")
            </th>
        </tr>
     </thead>
     <tbody></tbody>
</table>

@section Scripts
{
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
     <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script>
        $("#citySelect").select2({
            ajax: {
                url: '/Weather/getOneCiteBySelect',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.results,
                        pagination: { more: data.results.length >= 10 }
                    };
                }
            },
            placeholder: "Wpisz nazwę miasta",
            minimumInputLength: 0,
            templateResult: function (data) {
                if (!data.id) { return data.text; }
                return $(
                    `<div>
                        <strong>${data.text} </strong><br/>
                        <small>Lokalizacja: ${data.lat}, ${data.lon}</small>
                    </div>`
        );
    },
    templateSelection: function (data) {
        return data.name || data.text;
    }
        });

    $("#citySelect").on("select2:select", function (e) {
    var data = e.params.data;
        var unitMetric = $("#systemChoose").select2('data')[0];
                $.ajax({
                    url: '/Weather/JsonObjectReturn',   
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({

                             unitSystem: unitMetric.text,
                                coord: {                  
                                lat: data.lat,
                                lon: data.lon
                                }

                        }),     
                    success: function (city) {
                $("#cityTable").show();
                $("#cityTable tbody").html(`
                    <tr>
                        <td>${city.humidity}</td>
                        <td>${city.windSpeed}</td>
                        <td>${city.windDeg}</td>
                        <td>${city.description}</td>
                    </tr>
                `);
                $("#iconInfo p").html(`
                    <tr>
                    <td><img src="https://openweathermap.org/img/wn/${city.icon}.png" alt="${city.icon}" style="width:104px;height:142px;"></td>
                    <td><h2>${city.name}, ${city.temp}</h2></td>
                    </tr>
                `);
            },
                    error: function(err) {
                        console.error(err);
                    }
    });
});
$("#systemChoose").select2({
    ajax: {
        url: '/Weather/getSystems',
        dataType: 'json',
        delay: 250,
        data: function (params) {
            return { term: params.term || "" };
        },
        processResults: function (data) {
            return {
                results: data.map(function (name, index) {
                    return { id: index, text: name };
                })
            };
        }
    },
    minimumInputLength: 0
});

    </script>
}